<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventuras Cohete a la Escuela</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Soft blue-grey background */
            transition: background-color 0.5s;
        }
        /* Custom gradient for the rocket path */
        .path-gradient {
            background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%);
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');

        // Global variables from the canvas environment (MANDATORY USE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;

        // Game state
        let currentDay = 0; // 0=Lunes, 4=Viernes
        const daysOfWeek = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
        const MAX_DAYS = 5;

        // HTML elements
        const progressContainer = document.getElementById('progress-container');
        const rocket = document.getElementById('rocket');
        const currentDayDisplay = document.getElementById('current-day-display');
        const completeButton = document.getElementById('complete-button');
        const completeMessage = document.getElementById('complete-message');
        const levelMessage = document.getElementById('level-message');
        const titleText = document.getElementById('title-text');
        const cardElement = document.getElementById('game-card');
        const starElement = document.getElementById('school-star');

        // --- Utility Functions for Firebase/Game Logic ---

        /**
         * Converts base64 to ArrayBuffer for custom token login
         * @param {string} base64 The base64 string
         * @returns {ArrayBuffer} The array buffer
         */
        // This function is for internal use by the environment, kept for structure completeness
        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        /**
         * Initializes Firebase and authenticates the user.
         */
        const initializeFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // Wait for auth state change to get the userId
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User ID:", userId);
                        // Start loading the game data once authenticated
                        loadProgress();
                    } else {
                        // For anonymous or unauthenticated users, we must use a client-side identifier
                        userId = localStorage.getItem('anonUserId') || crypto.randomUUID();
                        localStorage.setItem('anonUserId', userId);
                        loadProgress(); // Load/start with anonymous ID
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
            }
        };

        /**
         * Gets the Firestore document reference for the user's progress.
         * Private data path: /artifacts/{appId}/users/{userId}/school_progress/daily_status
         */
        const getProgressDocRef = () => {
            if (!db || !userId) return null;
            return doc(db, `artifacts/${appId}/users/${userId}/school_progress/daily_status`);
        };

        /**
         * Loads the game progress in real-time using onSnapshot.
         */
        const loadProgress = () => {
            const docRef = getProgressDocRef();
            if (!docRef) {
                // If not authenticated yet, wait for onAuthStateChanged to call this again
                return;
            }

            // Real-time listener for progress updates
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentDay = data.completedDays || 0;
                    console.log("Progress loaded:", currentDay);
                } else {
                    // Initialize progress if document doesn't exist (first run)
                    currentDay = 0;
                    // Create the initial document
                    setDoc(docRef, { completedDays: 0, lastUpdated: new Date() })
                        .then(() => console.log("Initial progress set."))
                        .catch(err => console.error("Error setting initial progress:", err));
                }
                updateUI();
            }, (error) => {
                console.error("Error listening to progress:", error);
            });
        };

        /**
         * Updates the current progress in Firestore.
         * @param {number} newDay The new number of completed days.
         */
        const updateProgress = async (newDay) => {
            if (!db || !userId) {
                // Using console.error instead of alert as per instructions
                console.error("Error de autenticación. Por favor, recarga la página.");
                return;
            }

            const docRef = getProgressDocRef();

            try {
                await setDoc(docRef, {
                    completedDays: newDay,
                    lastUpdated: new Date()
                }, { merge: true });
                console.log("Progress updated successfully to day:", newDay);

                // The UI update logic is now handled robustly by the onSnapshot listener
                // which fires immediately after the setDoc completes.

            } catch (error) {
                console.error("Error updating progress:", error);
                // Re-enable the button if saving failed, so the user can try again
                if (completeButton) {
                    completeButton.removeAttribute('disabled');
                    completeButton.textContent = `¡Lo logré! (Completar ${daysOfWeek[currentDay]})`;
                }
            }
        };

        /**
         * Handles the button click to complete the current day.
         * Includes UX to disable the button during saving.
         */
        const handleCompleteDay = () => {
            if (currentDay < MAX_DAYS) {
                // UX: Disable the button and change text immediately to show progress
                completeButton.setAttribute('disabled', 'true');
                completeButton.textContent = 'Guardando...';

                const newDay = currentDay + 1;
                updateProgress(newDay);
            }
        };

        /**
         * Resets the game to the start (Day 0).
         * NOTE: window.confirm removed to comply with environment constraints.
         */
        const resetGame = () => {
            // Confirmation is implied by clicking the 'Empezar Nueva Semana' button in the completion modal.
            updateProgress(0);
            hideCompletionMessage();
        };

        /**
         * Updates the visual elements based on the currentDay state.
         */
        const updateUI = () => {
            // 1. Update Rocket Path
            const totalWidth = progressContainer.clientWidth;
            const pathSegment = (totalWidth - 120) / (MAX_DAYS - 1);
            
            // Calculate rocket position
            if (currentDay === MAX_DAYS) {
                rocket.style.left = `${totalWidth - 55}px`; // Right next to the star
            } else if (currentDay > 0) {
                 // Move rocket to the center of the segment it has completed
                 rocket.style.left = `${10 + pathSegment * (currentDay - 1) + (pathSegment / 2) - 15}px`;
            } else {
                 // Start position (Day 0 - Lunes)
                 rocket.style.left = '10px';
            }


            // 2. Update Day/Level Text
            if (currentDay < MAX_DAYS) {
                currentDayDisplay.textContent = `Día: ${daysOfWeek[currentDay]}`;
                completeButton.textContent = `¡Lo logré! (Completar ${daysOfWeek[currentDay]})`;
                completeButton.classList.remove('opacity-50', 'cursor-not-allowed', 'hidden');
                completeButton.removeAttribute('disabled'); // <-- FIX: REMOVE DISABLED ATTRIBUTE
                completeButton.onclick = handleCompleteDay;
                cardElement.classList.remove('border-green-500', 'shadow-green-300');
                cardElement.classList.add('border-blue-500', 'shadow-blue-300');
                titleText.textContent = "Aventuras Cohete a la Escuela";
                starElement.classList.remove('animate-pulse');
                document.body.style.backgroundColor = '#f0f4f8';
                hideCompletionMessage(); // Ensure modal is hidden if we reset mid-week
            } else {
                // Game Complete
                currentDayDisplay.textContent = `¡SEMANA COMPLETA!`;
                completeButton.classList.add('hidden'); // Hide the main button
                showCompletionMessage();
            }

            // 3. Update Progress Bar
            const segments = Array.from(progressContainer.querySelectorAll('.segment'));
            segments.forEach((segment, index) => {
                segment.classList.remove('bg-green-400', 'bg-blue-300', 'border-green-600', 'border-blue-500');
                if (index < currentDay) {
                    // Completed segment
                    segment.classList.add('bg-green-400', 'border-green-600');
                    segment.classList.remove('bg-blue-300', 'border-blue-500');
                } else {
                    // To be completed segment
                    segment.classList.add('bg-blue-300', 'border-blue-500');
                    segment.classList.remove('bg-green-400', 'border-green-600');
                }
            });
        };

        /**
         * Displays the final completion screen/modal.
         */
        const showCompletionMessage = () => {
            titleText.textContent = "¡Misión Cumplida! 🏆";
            cardElement.classList.remove('border-blue-500', 'shadow-blue-300');
            cardElement.classList.add('border-green-500', 'shadow-green-300');
            starElement.classList.add('animate-pulse');
            document.body.style.backgroundColor = '#e6ffec'; // Light green background for success

            // Show and populate the message box
            const messageTitle = document.getElementById('message-title');
            const messageBody = document.getElementById('message-body');
            const resetBtn = document.getElementById('reset-button');
            
            messageTitle.textContent = "¡ERES UN SUPERHÉROE!";
            messageBody.innerHTML = "¡Completaste toda la semana sin llorar en la escuela! Tu cohete ha llegado a la **Estrella de la Escuela**. Eres valiente y fuerte. ¡Ahora puedes empezar una nueva semana de aventuras!";
            resetBtn.onclick = resetGame;

            completeMessage.classList.remove('hidden');
        };

        /**
         * Hides the final completion screen/modal.
         */
        const hideCompletionMessage = () => {
            completeMessage.classList.add('hidden');
        };

        // --- Event Listeners and Initial Load ---
        window.onload = initializeFirebase;

    </script>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

    <!-- Main Game Card -->
    <div id="game-card" class="bg-white p-6 md:p-8 w-full max-w-lg rounded-3xl shadow-xl border-4 border-blue-500 transition duration-500 shadow-blue-300">
        
        <!-- Header -->
        <h1 id="title-text" class="text-4xl font-black text-center text-blue-800 mb-2">
            Aventuras Cohete a la Escuela
        </h1>
        <p class="text-center text-gray-600 mb-6 font-semibold">
            ¡Cada día sin llorar es un gran avance!
        </p>
        
        <!-- Current Day Display -->
        <div class="mb-6 bg-blue-100 p-4 rounded-xl text-center">
            <p id="current-day-display" class="text-2xl font-extrabold text-blue-700">Día: Cargando...</p>
        </div>

        <!-- Level/Progress Track (Rocket Path) -->
        <div class="relative h-20 mb-10 border-4 border-gray-300 rounded-full path-gradient shadow-inner">
            <!-- Rocket (Moves) -->
            <div id="rocket" class="absolute top-1/2 -translate-y-1/2 transition-all duration-700 transform" style="width: 40px; height: 40px; left: 10px;">
                <!-- Rocket SVG (Using a simple emoji/SVG for the rocket) -->
                <div class="text-4xl transform -rotate-45" role="img" aria-label="Rocket icon">🚀</div>
            </div>

            <!-- Goal Star -->
            <div id="school-star" class="absolute right-3 top-1/2 -translate-y-1/2 text-5xl text-yellow-500 transition duration-500" role="img" aria-label="School Star Goal">⭐</div>
            
            <!-- Progress Segments/Markers -->
            <div id="progress-container" class="absolute inset-0 flex justify-between items-center px-10">
                <!-- Day markers: L, M, Mi, J, V -->
                <div class="flex-1 flex justify-between h-full">
                    <!-- Path Segments -->
                    <div class="flex-1 flex justify-around items-center">
                        <div class="w-4 h-4 rounded-full border-4 segment transition duration-500 bg-blue-300 border-blue-500" title="Lunes"></div>
                        <div class="w-4 h-4 rounded-full border-4 segment transition duration-500 bg-blue-300 border-blue-500" title="Martes"></div>
                        <div class="w-4 h-4 rounded-full border-4 segment transition duration-500 bg-blue-300 border-blue-500" title="Miércoles"></div>
                        <div class="w-4 h-4 rounded-full border-4 segment transition duration-500 bg-blue-300 border-blue-500" title="Jueves"></div>
                        <!-- Final marker is the star -->
                    </div>
                </div>
            </div>

        </div>

        <!-- Feedback Message (Temporary) -->
        <p id="level-message" class="hidden text-center text-xl font-bold text-green-600 mb-6 bg-green-100 p-3 rounded-xl shadow-md transition duration-300">
            <!-- Populated by JS on success -->
        </p>

        <!-- Action Button -->
        <button id="complete-button"
            class="w-full py-4 text-white text-xl font-bold rounded-2xl bg-green-500 hover:bg-green-600 transition duration-300 transform hover:scale-[1.02] shadow-lg shadow-green-400/50"
            disabled
        >
            Cargando...
        </button>

    </div>

    <!-- Completion Modal (Hidden by default) -->
    <div id="complete-message" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 max-w-sm w-full rounded-3xl shadow-2xl border-4 border-green-500 text-center transform scale-100 transition-all duration-300">
            <div class="text-7xl mb-4">🏆</div>
            <h2 id="message-title" class="text-3xl font-black text-green-700 mb-3"></h2>
            <p id="message-body" class="text-gray-700 mb-6"></p>
            <button id="reset-button"
                class="w-full py-3 text-white text-lg font-bold rounded-xl bg-blue-500 hover:bg-blue-600 transition duration-300 shadow-md shadow-blue-400/50"
            >
                Empezar Nueva Semana
            </button>
        </div>
      Initial commit: Game v1.0
    </div>

</body>
</html>
